#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å½»åº•æ¸…é™¤Gitæç¤ºè„šæœ¬ - æ¶ˆé™¤VS Codeä¸­çš„57ä¸ªæ¨é€æç¤º
"""

import os
import subprocess
import sys
from pathlib import Path


def clear_all_git_changes():
    """å½»åº•æ¸…é™¤æ‰€æœ‰Gitå˜æ›´å’Œæç¤º"""
    print("ğŸ”§ å¼€å§‹å½»åº•æ¸…é™¤Gitæç¤º...")
    
    # 1. æ·»åŠ å½“å‰ç›®å½•æ‰€æœ‰å˜æ›´
    result = subprocess.run(['git', 'add', '.'], capture_output=True, text=True)
    if result.returncode != 0:
        print(f"æ·»åŠ å¤±è´¥: {result.stderr}")
        return False
    
    # 2. æäº¤æ‰€æœ‰å˜æ›´
    commit_msg = "æ›´æ–°ã€Šå¾¡å®šå…¨å”è©©ã€‹æ–‡ä»¶ç®¡ç†è§£å†³æ–¹æ¡ˆ"
    result = subprocess.run(['git', 'commit', '-m', commit_msg], capture_output=True, text=True)
    if result.returncode != 0:
        if "nothing to commit" in result.stderr:
            print("âœ… æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´")
            return True
        else:
            print(f"æäº¤å¤±è´¥: {result.stderr}")
            return False
    
    print("âœ… å·²æäº¤æ‰€æœ‰å˜æ›´")
    return True


def refresh_git_index():
    """åˆ·æ–°Gitç´¢å¼•ï¼Œç¡®ä¿VS Codeæ˜¾ç¤ºæ­£ç¡®çŠ¶æ€"""
    print("ğŸ”„ åˆ·æ–°Gitç´¢å¼•...")
    
    # é‡ç½®ç´¢å¼•
    subprocess.run(['git', 'reset'], capture_output=True)
    
    # é‡æ–°æ·»åŠ éœ€è¦çš„æ–‡ä»¶
    important_files = [
        '.gitignore',
        'push_list.txt',
        'exclude_list.txt', 
        'auto_git.py',
        'git_file_manager.py',
        'git_manager.bat',
        'ä¸€é”®è§£å†³.bat'
    ]
    
    for file in important_files:
        if Path(file).exists():
            subprocess.run(['git', 'add', file], capture_output=True)
    
    print("âœ… Gitç´¢å¼•å·²åˆ·æ–°")


def commit_essential_files():
    """æäº¤å¿…è¦çš„æ–‡ä»¶å¹¶æ¸…ç†çŠ¶æ€"""
    print("ğŸ“¦ æäº¤æ ¸å¿ƒæ–‡ä»¶...")
    
    # åˆ›å»ºæˆ–æ›´æ–°.gitignore
    gitignore_content = """# ã€Šå¾¡å®šå…¨å”è©©ã€‹é¡¹ç›®æ–‡ä»¶
# è‡ªåŠ¨ç”Ÿæˆå’Œç®¡ç†

# ç¯å¢ƒé…ç½®
.env
.env.local

# å¤„ç†æ•°æ®
website_data/*.json
json/*.json
ai_enhanced_*.json

# æ—¥å¿—æ–‡ä»¶
*.log
folder_ai_poem_processing.log

# å¤‡ä»½ç›®å½•
backup/

# Pythonç¼–è¯‘
__pycache__/
*.pyc
*.pyo

# IDE
.vscode/
.idea/

# ç³»ç»Ÿæ–‡ä»¶
.DS_Store
Thumbs.db

# æµ‹è¯•æ–‡ä»¶
*.test.json
test_*.py
"""
    
    with open('.gitignore', 'w', encoding='utf-8') as f:
        f.write(gitignore_content)
    
    # æ·»åŠ å¹¶æäº¤
    subprocess.run(['git', 'add', '.gitignore'])
    
    # åˆ›å»ºæäº¤
    result = subprocess.run(['git', 'commit', '-m', 'æ·»åŠ .gitignoreå’Œæ–‡ä»¶ç®¡ç†å·¥å…·'], 
                          capture_output=True, text=True)
    
    return result.returncode == 0


def clean_untracked_files():
    """æ¸…ç†æœªè·Ÿè¸ªçš„æ–‡ä»¶"""
    print("ğŸ§¹ æ¸…ç†æœªè·Ÿè¸ªæ–‡ä»¶...")
    
    # æŸ¥çœ‹æœªè·Ÿè¸ªçš„æ–‡ä»¶
    result = subprocess.run(['git', 'status', '--porcelain'], capture_output=True, text=True)
    untracked = [line[3:] for line in result.stdout.split('\n') if line.startswith('??')]
    
    print(f"å‘ç° {len(untracked)} ä¸ªæœªè·Ÿè¸ªæ–‡ä»¶:")
    for file in untracked:
        print(f"  - {file}")
    
    # è¯¢é—®æ˜¯å¦æ¸…ç†
    if untracked:
        response = input(f"æ˜¯å¦æ¸…ç†è¿™äº›æœªè·Ÿè¸ªæ–‡ä»¶? (y/N): ").lower()
        if response == 'y':
            for file in untracked:
                if Path(file).exists():
                    try:
                        Path(file).unlink()
                        print(f"å·²åˆ é™¤: {file}")
                    except Exception as e:
                        print(f"åˆ é™¤å¤±è´¥ {file}: {e}")


def verify_clean_state():
    """éªŒè¯GitçŠ¶æ€æ˜¯å¦å¹²å‡€"""
    print("âœ… éªŒè¯GitçŠ¶æ€...")
    
    result = subprocess.run(['git', 'status', '--porcelain'], capture_output=True, text=True)
    
    if not result.stdout.strip():
        print("ğŸ‰ GitçŠ¶æ€å®Œå…¨å¹²å‡€ï¼æ²¡æœ‰æœªæäº¤çš„å˜æ›´ã€‚")
        return True
    else:
        print(f"âš ï¸  ä»æœ‰æœªå¤„ç†çš„å˜æ›´:")
        print(result.stdout)
        return False


def force_refresh_vscode():
    """å¼ºåˆ¶åˆ·æ–°VS CodeçŠ¶æ€ï¼ˆé€šè¿‡æ“ä½œGitï¼‰"""
    print("ğŸ”„ å¼ºåˆ¶åˆ·æ–°GitçŠ¶æ€ä»¥æ›´æ–°VS Code...")
    
    # æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œæ¥è§¦å‘VS Codeåˆ·æ–°
    subprocess.run(['git', 'add', '-u'], capture_output=True)
    subprocess.run(['git', 'status'], capture_output=True)
    
    print("âœ… VS Codeåº”è¯¥ä¼šæ˜¾ç¤ºæœ€æ–°çš„GitçŠ¶æ€")


def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("ã€Šå¾¡å®šå…¨å”è©©ã€‹Gitæç¤ºæ¸…é™¤å·¥å…·")
    print("å½»åº•è§£å†³VS Codeä¸­çš„57ä¸ªæ¨é€æç¤º")
    print("=" * 60)
    
    # æ£€æŸ¥æ˜¯å¦åœ¨Gitä»“åº“ä¸­
    if not Path('.git').exists():
        print("âŒ å½“å‰ç›®å½•ä¸æ˜¯Gitä»“åº“")
        return 1
    
    try:
        # æ­¥éª¤1: æ¸…ç†æœªè·Ÿè¸ªæ–‡ä»¶
        clean_untracked_files()
        
        # æ­¥éª¤2: æäº¤æ‰€æœ‰å˜æ›´
        if clear_all_git_changes():
            print("âœ… å·²å¤„ç†æ‰€æœ‰å˜æ›´")
        
        # æ­¥éª¤3: åˆ·æ–°ç´¢å¼•
        refresh_git_index()
        
        # æ­¥éª¤4: æäº¤æ ¸å¿ƒæ–‡ä»¶
        if commit_essential_files():
            print("âœ… å·²æäº¤æ ¸å¿ƒæ–‡ä»¶")
        
        # æ­¥éª¤5: éªŒè¯çŠ¶æ€
        if verify_clean_state():
            print("\nğŸ‰ æˆåŠŸï¼æ‰€æœ‰Gitæç¤ºå·²æ¸…é™¤")
            print("VS Codeä¸­çš„æ¨é€æç¤ºåº”è¯¥ç«‹å³æ¶ˆå¤±")
        else:
            print("\nâš ï¸  ä»æœ‰æ®‹ç•™å˜æ›´ï¼Œè¯·æ‰‹åŠ¨å¤„ç†")
        
        # æ­¥éª¤6: å¼ºåˆ¶åˆ·æ–°
        force_refresh_vscode()
        
    except Exception as e:
        print(f"âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        return 1
    
    print("=" * 60)
    print("ğŸ¯ Gitæç¤ºæ¸…é™¤æ“ä½œå®Œæˆ")
    print("=" * 60)
    
    return 0


if __name__ == "__main__":
    sys.exit(main())